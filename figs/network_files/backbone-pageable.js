!function(e){if("object"==typeof exports)module.exports=e(require("underscore"),require("backbone"));else if("function"==typeof define&&define.amd)define(["underscore","backbone"],e);else if("undefined"!=typeof _&&"undefined"!=typeof Backbone){var t=Backbone.PageableCollection,r=e(_,Backbone);Backbone.PageableCollection.noConflict=function(){return Backbone.PageableCollection=t,r}}}(function(e,t){"use strict";function r(t,r){if(!e.isNumber(t)||e.isNaN(t)||!e.isFinite(t)||~~t!==t)throw new TypeError("`"+r+"` must be a finite integer");return t}function s(e){for(var t,r,s,a,i={},n=decodeURIComponent,o=e.split("&"),l=0,c=o.length;l<c;l++){t=o[l].split("="),r=t[0],s=t[1]||"",r=n(r),s=n(s.replace(/\+/g,"%20")),a=i[r],d(a)?a.push(s):i[r]=a?[a,s]:s}return i}function a(e,t,r){var s=e._events[t];if(s&&s.length){var a=s[s.length-1],i=a.callback;a.callback=function(){try{i.apply(this,arguments),r()}catch(e){throw e}finally{a.callback=i}}}else r()}var i=e.extend,n=e.omit,o=e.clone,l=e.each,c=e.pick,u=e.contains||e.includes,f=e.isEmpty,h=e.pairs||e.toPairs,g=e.invert,d=e.isArray,P=e.isFunction,m=e.isObject,p=e.keys,v=e.isUndefined,y=Math.ceil,k=Math.floor,b=Math.max,S=t.Collection.prototype,_=/[\s'"]/g,R=/[<>\s'"]/g,C=t.PageableCollection=t.Collection.extend({state:{firstPage:1,lastPage:null,currentPage:null,pageSize:25,totalPages:null,totalRecords:null,sortKey:null,order:-1},mode:"server",queryParams:{currentPage:"page",pageSize:"per_page",totalPages:"total_pages",totalRecords:"total_entries",sortKey:"sort_by",order:"order",directions:{"-1":"asc",1:"desc"}},constructor:function(e,t){S.constructor.apply(this,arguments),t=t||{};var r=this.mode=t.mode||this.mode||x.mode,s=i({},x.queryParams,this.queryParams,t.queryParams||{});s.directions=i({},x.queryParams.directions,this.queryParams.directions,s.directions||{}),this.queryParams=s;var a=this.state=i({},x.state,this.state,t.state||{});a.currentPage=null==a.currentPage?a.firstPage:a.currentPage,d(e)||(e=e?[e]:[]),e=e.slice(),"server"==r||null!=a.totalRecords||f(e)||(a.totalRecords=e.length),this.switchMode(r,i({fetch:!1,resetState:!1,models:e},t));var n=t.comparator;if(a.sortKey&&!n&&this.setSorting(a.sortKey,a.order,t),"server"!=r){var l=this.fullCollection;n&&t.full&&(this.comparator=null,l.comparator=n),t.full&&l.sort(),e&&!f(e)&&(this.reset(e,i({silent:!0},t)),this.getPage(a.currentPage),e.splice.apply(e,[0,e.length].concat(this.models)))}this._initState=o(this.state)},_makeFullCollection:function(e,r){var s,a,i,n=["url","model","sync","comparator"],o=this.constructor.prototype,l={};for(s=0,a=n.length;s<a;s++)i=n[s],v(o[i])||(l[i]=o[i]);var c=new(t.Collection.extend(l))(e,r);for(s=0,a=n.length;s<a;s++)i=n[s],this[i]!==o[i]&&(c[i]=this[i]);return c},_makeCollectionEventHandler:function(e,t){return function(r,s,n,c){var u=e._handlers;l(p(u),function(r){var s=u[r];e.off(r,s),t.off(r,s)});var f=o(e.state),h=f.firstPage,g=0===h?f.currentPage:f.currentPage-1,d=f.pageSize,P=g*d,m=P+d;if("add"==r){var k,b,S,_,c=c||{};if(n==t)(b=t.indexOf(s))>=P&&b<m&&(_=e,k=S=b-P);else{k=e.indexOf(s),b=P+k,_=t;var S=v(c.at)?b:c.at+P}if(c.onRemove||(++f.totalRecords,delete c.onRemove),e.state=e._checkState(f),_){_.add(s,i({},c||{},{at:S}));var R=k>=d?s:!v(c.at)&&S<m&&e.length>d?e.at(d):null;R&&a(n,r,function(){e.remove(R,{onAdd:!0})})}}if("remove"==r)if(c.onAdd)delete c.onAdd;else{if(--f.totalRecords){var C=f.totalPages=y(f.totalRecords/d);f.lastPage=0===h?C-1:C||h,f.currentPage>C&&(f.currentPage=f.lastPage)}else f.totalRecords=null,f.totalPages=null;e.state=e._checkState(f);var x,w=c.index;n==e?((x=t.at(m))?a(e,r,function(){e.push(x,{onRemove:!0})}):!e.length&&f.totalRecords&&e.reset(t.models.slice(P-d,m-d),i({},c,{parse:!1})),t.remove(s)):w>=P&&w<m&&((x=t.at(m-1))&&a(e,r,function(){e.push(x,{onRemove:!0})}),e.remove(s),!e.length&&f.totalRecords&&e.reset(t.models.slice(P-d,m-d),i({},c,{parse:!1})))}if("reset"==r)if(c=n,(n=s)==e&&null==c.from&&null==c.to){var q=t.models.slice(0,P),z=t.models.slice(P+e.models.length);t.reset(q.concat(e.models).concat(z),c)}else n==t&&((f.totalRecords=t.models.length)||(f.totalRecords=null,f.totalPages=null),"client"==e.mode&&(f.lastPage=f.currentPage=f.firstPage),e.state=e._checkState(f),e.reset(t.models.slice(P,m),i({},c,{parse:!1})));"sort"==r&&(c=n,(n=s)===t&&e.reset(t.models.slice(P,m),i({},c,{parse:!1}))),l(p(u),function(r){var s=u[r];l([e,t],function(e){e.on(r,s);var t=e._events[r]||[];t.unshift(t.pop())})})}},_checkState:function(e){var t=this.mode,s=this.links,a=e.totalRecords,i=e.pageSize,n=e.currentPage,o=e.firstPage,l=e.totalPages;if(null!=a&&null!=i&&null!=n&&null!=o&&("infinite"!=t||s)){if(a=r(a,"totalRecords"),i=r(i,"pageSize"),n=r(n,"currentPage"),o=r(o,"firstPage"),i<1)throw new RangeError("`pageSize` must be >= 1");if(l=e.totalPages=y(a/i),o<0||o>1)throw new RangeError("`firstPage must be 0 or 1`");if(e.lastPage=0===o?b(0,l-1):l||o,"infinite"==t){if(!s[n+""])throw new RangeError("No link found for page "+n)}else if(n<o||l>0&&(o?n>l:n>=l))throw new RangeError("`currentPage` must be firstPage <= currentPage "+(o?">":">=")+" totalPages if "+o+"-based. Got "+n+".")}return e},setPageSize:function(e,t){e=r(e,"pageSize"),t=t||{first:!1};var s=this.state,a=y(s.totalRecords/e),o=a?b(s.firstPage,k(a*s.currentPage/s.totalPages)):s.firstPage;return s=this.state=this._checkState(i({},s,{pageSize:e,currentPage:t.first?s.firstPage:o,totalPages:a})),this.getPage(s.currentPage,n(t,["first"]))},switchMode:function(t,r){if(!u(["server","client","infinite"],t))throw new TypeError('`mode` must be one of "server", "client" or "infinite"');r=r||{fetch:!0,resetState:!0};var s=this.state=r.resetState?o(this._initState):this._checkState(i({},this.state));this.mode=t;var a,c=this,f=this.fullCollection,h=this._handlers=this._handlers||{};if("server"==t||f)"server"==t&&f&&(l(p(h),function(e){a=h[e],c.off(e,a),f.off(e,a)}),delete this._handlers,this._fullComparator=f.comparator,delete this.fullCollection);else{f=this._makeFullCollection(r.models||[],r),f.pageableCollection=this,this.fullCollection=f;var g=this._makeCollectionEventHandler(this,f);l(["add","remove","reset","sort"],function(t){h[t]=a=e.bind(g,{},t),c.on(t,a),f.on(t,a)}),f.comparator=this._fullComparator}if("infinite"==t)for(var d=this.links={},P=s.firstPage,m=y(s.totalRecords/s.pageSize),v=0===P?b(0,m-1):m||P,k=s.firstPage;k<=v;k++)d[k]=this.url;else this.links&&delete this.links;return r.fetch?this.fetch(n(r,"fetch","resetState")):this},hasPreviousPage:function(){var e=this.state,t=e.currentPage;return"infinite"!=this.mode?t>e.firstPage:!!this.links[t-1]},hasNextPage:function(){var e=this.state,t=this.state.currentPage;return"infinite"!=this.mode?t<e.lastPage:!!this.links[t+1]},getFirstPage:function(e){return this.getPage("first",e)},getPreviousPage:function(e){return this.getPage("prev",e)},getNextPage:function(e){return this.getPage("next",e)},getLastPage:function(e){return this.getPage("last",e)},getPage:function(e,t){var s=this.mode,a=this.fullCollection;t=t||{fetch:!1};var o=this.state,l=o.firstPage,c=o.currentPage,u=o.lastPage,h=o.pageSize,g=e;switch(e){case"first":g=l;break;case"prev":g=c-1;break;case"next":g=c+1;break;case"last":g=u;break;default:g=r(e,"index")}this.state=this._checkState(i({},o,{currentPage:g})),t.from=c,t.to=g;var d=(0===l?g:g-1)*h,P=a&&a.length?a.models.slice(d,d+h):[];return"client"!=s&&("infinite"!=s||f(P))||t.fetch?("infinite"==s&&(t.url=this.links[g]),this.fetch(n(t,"fetch"))):(this.reset(P,n(t,"fetch")),this)},getPageByOffset:function(e,t){if(e<0)throw new RangeError("`offset must be > 0`");e=r(e);var s=k(e/this.state.pageSize);return 0!==this.state.firstPage&&s++,s>this.state.lastPage&&(s=this.state.lastPage),this.getPage(s,t)},sync:function(e,r,s){var a=this;if("infinite"==a.mode){var n=s.success,o=a.state.currentPage;s.success=function(e,t,r){var l=a.links,c=a.parseLinks(e,i({xhr:r},s));c.first&&(l[a.state.firstPage]=c.first),c.prev&&(l[o-1]=c.prev),c.next&&(l[o+1]=c.next),n&&n(e,t,r)}}return(S.sync||t.sync).call(a,e,r,s)},parseLinks:function(e,t){var r={},s=t.xhr.getResponseHeader("Link");if(s){var a=["first","prev","next"];l(s.split(","),function(e){var t=e.split(";"),s=t[0].replace(R,""),i=t.slice(1);l(i,function(e){var t=e.split("="),i=t[0].replace(_,""),n=t[1].replace(_,"");"rel"==i&&u(a,n)&&(r[n]=s)})})}return r},parse:function(e,t){var r=this.parseState(e,o(this.queryParams),o(this.state),t);return r&&(this.state=this._checkState(i({},this.state,r))),this.parseRecords(e,t)},parseState:function(t,r,s,a){if(t&&2===t.length&&m(t[0])&&d(t[1])){var i=o(s),c=t[0];return l(h(n(r,"directions")),function(t){var r=t[0],s=t[1],a=c[s];v(a)||e.isNull(a)||(i[r]=c[s])}),c.order&&(i.order=1*g(r.directions)[c.order]),i}},parseRecords:function(e,t){return e&&2===e.length&&m(e[0])&&d(e[1])?e[1]:e},fetch:function(e){e=e||{};var t=this._checkState(this.state),r=this.mode;"infinite"!=r||e.url||(e.url=this.links[t.currentPage]);var a=e.data||{},l=e.url||this.url||"";P(l)&&(l=l.call(this));var u=l.indexOf("?");-1!=u&&(i(a,s(l.slice(u+1))),l=l.slice(0,u)),e.url=l,e.data=a;var f,g,d,m,y="client"==this.mode?c(this.queryParams,"sortKey","order"):n(c(this.queryParams,p(x.queryParams)),"directions"),k=h(y),b=o(this);for(f=0;f<k.length;f++)g=k[f],d=g[0],m=g[1],m=P(m)?m.call(b):m,null!=t[d]&&null!=m&&(a[m]=t[d]);if(t.sortKey&&t.order){a[P(y.order)?y.order.call(b):y.order]=this.queryParams.directions[t.order+""]}else t.sortKey||delete a[y.order];var _=h(n(this.queryParams,p(x.queryParams)));for(f=0;f<_.length;f++)g=_[f],m=g[1],null!=(m=P(m)?m.call(b):m)&&(a[g[0]]=m);if("server"!=r){var R=this,C=this.fullCollection,w=e.success;return e.success=function(t,s,a){a=a||{},v(e.silent)?delete a.silent:a.silent=e.silent;var n=t.models;"client"==r?C.reset(n,a):(C.add(n,i({at:C.length},i(a,{parse:!1}))),R.trigger("reset",R,a)),w&&w(t,s,a)},S.fetch.call(this,i({},e,{silent:!0}))}return S.fetch.call(this,e)},_makeComparator:function(e,t,r){var s=this.state;if(e=e||s.sortKey,t=t||s.order,e&&t)return r||(r=function(e,t){return e.get(t)}),function(s,a){var i,n=r(s,e),o=r(a,e);return 1===t&&(i=n,n=o,o=i),n===o?0:n<o?-1:1}},setSorting:function(e,t,r){var s=this.state;s.sortKey=e,s.order=t=t||s.order;var a=this.fullCollection,n=!1,o=!1;e||(n=o=!0);var l=this.mode;r=i({side:"client"==l?l:"server",full:!0},r);var c=this._makeComparator(e,t,r.sortValue),u=r.full,f=r.side;return"client"==f?u?(a&&(a.comparator=c),n=!0):(this.comparator=c,o=!0):"server"!=f||u||(this.comparator=c),n&&(this.comparator=null),o&&a&&(a.comparator=null),this}}),x=C.prototype;return C});