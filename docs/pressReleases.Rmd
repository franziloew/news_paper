---
title: "Press Releases"
output: html_document
---

```{r include=FALSE}
library(tidyverse)
library(lubridate)

rm(list = ls())
```

- Unterschied zw. Partei und Fraktion: Parteien werden über Mitgliedsbeiträge, Spenden, Wahlkampfkostenerstattung finanziert, Fraktion über staatl. Mittel. Staatl. alimentierten Fraktionen dürfen Parteien nicht aus ihrern Mitteln unterstützen (Parteigesetzt §25 (2)). (sonst würden Parteien, die nicht im Bundestag sind praktisch benachteiligt.)

- Trotzdem greifen die relativ gut ausgestatteten Fraktionen mit ihren Pressemitteilungen in den Wahlkampf ein. Grenzlinie zwischen Fraktionstätigkeit und Wahlkampfhilfe ist schwer zu ziehen.

## Load Data

### CDU

- Partei (https://www.cdu.de)
- Fraktion / Union (https://www.presseportal.de)

```{r include=FALSE}
# Partei
load("../data/pressReleases/cdu.Rda")
cdu.p <- cdu %>% mutate(type = "party") %>% select(-scrape_time, -source)

# Fraktion
cdu.f <- read.csv("../data/pressReleases/python/cdu.csv", stringsAsFactors=FALSE)
cdu.f <- cdu.f %>% mutate(type = "fraction") %>% select(-link)

# combine both
cdu <- rbind(cdu.p,cdu.f) %>% 
  # date format
  mutate(date = as.Date(date, format="%d.%m.%Y")) %>% 
  # filter time perion
  filter(date >= as.Date("2017-06-01")) %>%
  filter(date < as.Date("2018-03-01")) %>%
  
  # clean text
  mutate(text = gsub('Berlin','',body, ignore.case = TRUE, perl = TRUE),
         text = gsub('ots','',text, ignore.case = TRUE, perl = TRUE),
         text = gsub('Presse.*','', text, perl = TRUE, ignore.case = TRUE),
         text = gsub('Telefon.*','', text, perl = TRUE, ignore.case = TRUE),
         text = gsub('Fax.*','', text, perl = TRUE, ignore.case = TRUE),
         text = gsub('Internet.*','', text, perl = TRUE, ignore.case = TRUE),
         text = gsub('Email.*','', text, perl = TRUE, ignore.case = TRUE),
         title = gsub('(.+?):','',title, perl = T),
         title_text = paste(title, text),
         party = "CDU"
         ) %>%
  distinct(title, .keep_all = T) %>%
  # remove text about inner-party votes
  filter(!grepl("wahl ",title,ignore.case = T)) %>%
  # keep variables 
  select(title_text, party, type, date)

rm(cdu.f, cdu.p)
```

### SPD

- Partei (https://www.spd.de)
- Fraktion (https://www.spdfraktion.de)

```{r include=FALSE}
# Partei
load("../data/pressReleases/spd.Rda")
spd.p <- spd %>% mutate(type = "party",
                        date = as.Date(date, format="%d.%m.%Y")
                        ) %>% select(-scrape_time, -source)

# Fraktion
spd.f <- read.csv("../data/pressReleases/python/spd.csv", stringsAsFactors=FALSE)
spd.f <- spd.f %>% mutate(type = "fraction",
                          date = as.Date(gsub('\\|.*','',date, perl = T), format = "%d.%m.%Y")
                          ) %>% select(-link) 

# combine both
spd <- rbind(spd.p,spd.f) %>%
  # filter time perion
  filter(date >= as.Date("2017-06-01")) %>%
  filter(date < as.Date("2018-03-01")) %>%
  
  # clean text
  mutate(text = gsub('(.+?):','', body, perl = TRUE, ignore.case = TRUE),
         title = title,
         title_text = paste(title, text),
         party = "SPD"
         ) %>%
  distinct(title, .keep_all = T) %>%
  # remove text about inner-party votes
  filter(!grepl("wahl ",title,ignore.case = T)) %>%
  # keep variables 
  select(title_text, party, type, date)
  
rm(spd.f, spd.p)
```

### FDP

- Partei (https://www.fdp.de)
- Fraktion (https://www.fdpbt.de)

```{r include=FALSE}
fdp.p <- read.csv("../data/pressReleases/python/fdp.csv", stringsAsFactors=FALSE)

fdp.p <- fdp.p %>%
  mutate(
    date = as.Date(date, format = "%d.%m.%Y"),
    title = gsub('\n','',title, perl = T),
    type = "party") 

fdp.f <- read.csv("../data/pressReleases/python/fdpbt.csv", stringsAsFactors=FALSE)

fdp.f <- fdp.f %>% 
  mutate(
        date = as.Date(date, format="%d.%m.%Y"),
        title = gsub('\n','', title, perl = T),
        title = gsub('\t','', title, perl = T),
        type = "fraction")

# combine both
fdp <- rbind(fdp.p,fdp.f) %>%
  
  filter(!grepl("Gastbeitrag",title)) %>%
  filter(!grepl("Interview",title)) %>%
  
  # clean text
  mutate(title = gsub('(.+?):','', title, perl = TRUE, ignore.case = TRUE),
         title_text = paste(title, body),
         party = "FDP"
         ) %>%
  distinct(title, .keep_all = T) %>%
  # remove text about inner-party votes
  filter(!grepl("wahl ",title,ignore.case = T)) %>%
  # keep variables 
  select(title_text, party, type, date)
  
rm(fdp.f, fdp.p)
```

### B90 / Die Grünen

- Partei (https://www.gruene.de)
- Fraktion (https://www.gruene-bundestag.de/)

```{r include=FALSE}
# Partei 
load("../data/pressReleases/gruene.Rda")
gruene.p <- gruene %>% mutate(type = "party",
                              date = as.Date(date, format="%d.%m.%Y")
                              ) %>% select(-scrape_time, -source)

# Fraktion
gruene.f <- read.csv("../data/pressReleases/python/gruene.csv", stringsAsFactors=FALSE)
gruene.f <- gruene.f %>% mutate(type = "fraction",
                                date = as.Date(date, format="%d.%m.%Y")) %>% select(-link, -party) 

# combine both
gruene <- rbind(gruene.p,gruene.f) %>%
  # clean text
  mutate(text = gsub('Die Fraktionspressestelle auf Twitter: @GruenSprecher','',body),
         title = title,
         title_text = paste(title, text),
         party = "B90/GRÜNE"
         ) %>%
  distinct(title, .keep_all = T) %>%
  # remove text about inner-party votes
  filter(!grepl("wahl ",title,ignore.case = T)) %>%
  # keep variables 
  select(title_text, party, type, date)

rm(gruene.f, gruene.p)
```

### DIE LINKE

- Partei (https://www.die-linke.de)
- Fraktion (https://www.die-linke.de/start/presse/aus-dem-bundestag/)

```{r include=FALSE}
# Partei 
load("../data/pressReleases/linke.Rda")
linke.p <- linke %>% mutate(type = "party",
                            date = as.Date(date, format="%d.%m.%Y")
                            ) %>% select(-scrape_time, -source)

# Fraktion
linke.f <- read.csv("../data/pressReleases/python/linke.csv", stringsAsFactors=FALSE)
linke.f <- linke.f %>% mutate(type = "fraction",
                              date = gsub("\n","", date, perl = T),
                              date = as.Date(date, format="%d. %b %Y")) %>% select(-link, -party) 

# combine both
linke <- rbind(linke.p,linke.f) %>%
  # filter time perion
  filter(date >= as.Date("2017-06-01")) %>%
  filter(date < as.Date("2018-03-01")) %>%
  
  # clean text
  mutate(text = body,
         title = title,
         title_text = paste(title, text),
         party = "DIE LINKE"
         ) %>%
  distinct(title, .keep_all = T) %>%
  # keep variables 
  select(title_text, party, type, date)

rm(linke.f, linke.p)
```

### AfD

- Partei (https://www.afd.de)
- Fraktion (https://www.afdbundestag.de)

```{r include=FALSE}
load("../data/pressReleases/afd.Rda")
load("../data/pressReleases/afdf.Rda")

afd <- rbind(afd, afd.f %>% mutate(source = "AfD")) %>%
  mutate( date = str_extract(body, "(?<=,\\s)(\\d{1,2}.\\s\\w{1,}\\s\\d{4})"),
          date = as.Date(date, format = "%d. %B %Y"),
          text = gsub('Berlin[^n\\.]*','',body, ignore.case = TRUE, perl = TRUE),
          text = gsub(".fusion-button[^\n]*",'',text, ignore.case = TRUE, perl = TRUE),
          title_text = paste(title, body),
          type = "party",
          party = "AfD"
          ) %>%
  distinct(title, .keep_all = T) %>%
  select(title_text, party, type, date)

rm(afd.f)
```

```{r include=FALSE}
filter <- paste("wahl","wählt","personalentscheidung","gremien","rufbereitschaft","erreichbarkeit", sep = "|")
  
pressReleases <- bind_rows(cdu, spd, afd, gruene, linke, fdp) %>%
  filter(date >= as.Date("2017-06-01")) %>%
  filter(date < as.Date("2018-03-01")) %>%
  mutate(type = "press",
         text_length = sapply(gregexpr("\\S+", title_text), length)) %>%
  # remove text about inner-party votes
  filter(!grepl(filter,title_text,ignore.case = T)) %>%
  filter(text_length > 50) %>%
  filter(text_length < 2000)
```

```{r echo=FALSE}
pressReleases %>%
  group_by(party) %>%
  tally() %>%
  ggplot(aes(reorder(party, n),n)) +
  geom_col(fill="blue", alpha=0.6) +
  coord_flip() +
  ggthemes::theme_hc() +
  labs(y = NULL, x = NULL, title = "Number of press releases (June 2017 - March 2018)")
```

## Clean Data

```{r eval=FALSE, include=FALSE}
pressReleases$text_cleaned <- gsub("[[:punct:]]", " ", pressReleases$title_text)
pressReleases$text_cleaned <- gsub("[[:cntrl:]]", " ", pressReleases$text_cleaned)
pressReleases$text_cleaned <- gsub("[[:digit:]]", " ", pressReleases$text_cleaned)
pressReleases$text_cleaned <- gsub("^[[:space:]]+", " ", pressReleases$text_cleaned)
pressReleases$text_cleaned <- gsub("[[:space:]]+$", " ", pressReleases$text_cleaned)
pressReleases$text_cleaned <- tolower(pressReleases$text_cleaned)

## Remove stopwords
# 1
german_stopwords_full <- read.table("dict/german_stopwords_full.txt", stringsAsFactors = F)
german_stopwords_full <- german_stopwords_full$V1

# 2
mystopwords <- c("januar","feburar","märz","april","mai","juni","juli","drucken","bundestagsfraktion",
                 "august","september","oktober","november","dezember","button",
                 "linke","cdu","csu","union","spd","afd","grüne","fdp"
                 )
stopwords <- c(german_stopwords_full, mystopwords)
stopwords <- unique(stopwords)

# 3
pressReleases$text_cleaned<- tm::removeWords(pressReleases$text_cleaned, stopwords)

## Stemming
stem_text<- function(text, language = "porter", mc.cores = 1) {
  # stem each word in a block of text
  stem_string <- function(str, language) {
    str <- strsplit(x = str, split = "\\s")
    str <- SnowballC::wordStem(unlist(str), language = language)
    str <- paste(str, collapse = " ")
    return(str)
  }
   
  # stem each text block in turn
  x <- parallel::mclapply(X = text, FUN = stem_string, language, mc.cores = mc.cores)
   
  # return stemed text blocks
  return(unlist(x))
}

pressReleases$text_cleaned1 <- stem_text(pressReleases$text_cleaned)
```

```{r eval=FALSE, include=FALSE}
save(pressReleases, file = "../output/pressReleases.Rda")
```

```{r include=FALSE}
library(tidyverse)
library(tidytext)

rm(list = ls())
load("../output/pressReleases.Rda")
```

```{r echo=FALSE}
pressReleases %>%
  sample_n(1) %>%
  select(title_text, text_cleaned) %>%
  htmlTable::htmlTable()
```

## Inspect Data

```{r include=FALSE}
tokens <- pressReleases %>% unnest_tokens(word, text_cleaned)
bigrams <- pressReleases %>% unnest_tokens(bigrams, text_cleaned, token="ngrams", n=2)
```

### Tokens

```{r echo=FALSE, fig.height=10, fig.width=10, message=FALSE, warning=FALSE}
tokens2 <- tokens %>%
  count(party, word, sort = TRUE) %>%
  ungroup() %>%
  bind_tf_idf(word,party,n)

tokens2 %>% 
    arrange(desc(tf)) %>%
  mutate(word = factor(word, levels = rev(unique(word)))) %>% 
  group_by(party) %>% 
  top_n(10) %>% 
  ungroup %>%
  ggplot(aes(word, tf, fill = party)) +
  geom_col(show.legend = FALSE) +
  labs(x = NULL, y = "tf-idf") +
  facet_wrap(~party, ncol = 2, scales = "free") +
  coord_flip()
```

### Bigrams
```{r echo=FALSE, fig.height=10, fig.width=10, message=FALSE, warning=FALSE}
bigrams2 <- bigrams %>%
  count(party, bigrams, sort = TRUE) %>%
  ungroup() %>%
  bind_tf_idf(bigrams,party,n)

bigrams2 %>% 
    arrange(desc(tf_idf)) %>%
  mutate(word = factor(bigrams, levels = rev(unique(bigrams)))) %>% 
  group_by(party) %>% 
  top_n(10) %>%
  ungroup %>%
  ggplot(aes(bigrams, tf_idf, fill = party)) +
  geom_col(show.legend = FALSE) +
  labs(x = NULL, y = "tf-idf") +
  facet_wrap(~party, ncol = 2, scales = "free") +
  coord_flip()
```


