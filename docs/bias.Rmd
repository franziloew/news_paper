---
title: "Different types of media bias"
author: "Franziska LÃ¶w"
date: "`r format(Sys.Date())`"
output: html_document
---


```{r include=FALSE}
rm(list = ls())
library(tidyverse)
library(ggthemes)
library(lubridate)
library(scales)
```

```{r Normalize Data Function, include=FALSE}
normalize_data <- function(x) {
  # normalize data between -1,1
  if (is.numeric(x)) {
    y <- 2*((x - min(x, na.rm = T)) / (max(x, na.rm = T) - min(x, na.rm = T)))-1
    return(y)
  } else {
    return(x)
  }

}
```

```{r Load Data, include=FALSE}
load("../output/agenda.Rda")
load("../output/sentiment.Rda")
load("../output/visibility.Rda")

# combine dfs
df <- left_join(agenda %>% select(-date),
                sent, by = c("month","year","medium","party")) %>%
  left_join(.,vis %>% select(medium, month, year, party, vis),
            by = c("month","year","medium","party")) %>%
  # normalize data
  mutate(
    vis_norm = normalize_data(vis),
    sent_norm = normalize_data(sent),
    cor_norm = normalize_data(cor),
    date =as.Date(paste("01",month,year, sep = "-"), format="%d-%m-%Y")
  )
```

# Inspect data

### Visibility 

```{r echo=FALSE}
df %>%
  ggplot(aes(date, vis_norm, color = medium, group = medium)) +
  geom_line() +
  geom_hline(yintercept = 0, size = 0.3, color = "grey30", linetype = 2) +
  facet_wrap(~party) +
  labs(y = "visibility", x =NULL) +
  guides(colour = guide_legend(nrow = 1)) +
  theme(legend.position = "bottom",
        legend.title = element_blank())
```

### Sentiment 

```{r echo=FALSE}
df %>%
  ggplot(aes(date, sent_norm, color = medium, group = medium)) +
  geom_line() +
  geom_hline(yintercept = 0, size = 0.3, color = "grey30", linetype = 2) +
  facet_wrap(~party) +
  labs(y = "sentiment", x =NULL) +
  guides(colour = guide_legend(nrow = 1)) +
  theme(legend.position = "bottom",
        legend.title = element_blank())
```

### Agenda correlation

```{r echo=FALSE}
df %>%
  ggplot(aes(date, cor_norm, color = medium, group = medium)) +
  geom_line() +
  geom_hline(yintercept = 0, size = 0.3, color = "grey30", linetype = 2) +
  facet_wrap(~party) +
  labs(y = "agenda correlation", x =NULL) +
  guides(colour = guide_legend(nrow = 1)) +
  theme(legend.position = "bottom",
        legend.title = element_blank())
```

# Bias 

## Standing in polls

We use the data from the "Sonntagsumfrage" (Sunday survey) from [infratest dimap](https://www.infratest-dimap.de/umfragen-analysen/bundesweit/sonntagsfrage/). The institution regularly asks at least 1000 German citizens the question: "Which party would you choose if federal elections take place next Sunday?" The survey thus measures the current election tendencies and therefore reflects an intermediate state in the opinion-forming process of the electoral population.

```{r include=FALSE}
# Import and prepare survey data
load("../output/polls.Rda")

polls <- table_long %>%
  dplyr::mutate(
    year = lubridate::year(Datum),
    month = lubridate::month(Datum),
    date = as.Date(paste0(year,"/",month,"/1"))
    ) %>%
  filter(Datum > as.Date("2017-05-31")) %>%
  filter(Datum < as.Date("2018-03-01")) %>%
  filter(!party %in% c("Piraten", "Sonstige")) %>%
  group_by(year,month,date, party) %>%
  dplyr::summarise(poll_value = mean(value, na.rm=T)) %>%
  ungroup() %>%
  mutate(poll_norm = normalize_data(poll_value))
```

```{r echo=FALSE}
polls %>%
  ggplot(aes(date, poll_norm)) +
  geom_line() +
  geom_hline(yintercept = 0, size = 0.3, color = "grey30", linetype = 2) +
  facet_wrap(~party) +
  labs(y = "poll value", x =NULL) +
  guides(colour = guide_legend(nrow = 1)) +
  theme(legend.position = "bottom",
        legend.title = element_blank())
```

```{r estimate bias, include=FALSE}
biasDF <- left_join(df, polls %>% select(-date), 
                    by = c('party','month','year')) %>%
  # estimate deviation from the poll value
  mutate(agenda_bias1 = cor_norm - poll_norm,
            sent_bias1 = sent_norm - poll_norm,
            vis_bias1 = vis_norm - poll_norm,
            month = month,
            year = year,
            medium = medium,
            party = party,
            date = date
            ) 
```

### Visibility 

```{r echo=FALSE}
biasDF %>%
  ggplot(aes(date, vis_bias1, color = medium, group = medium)) +
  geom_line() +
  scale_y_continuous(limits = c(-1,1.5)) +
  geom_hline(yintercept = 0, size = 0.3, color = "grey30", linetype = 2) +
  facet_wrap(~party) +
  labs(y = "visibility bias", x =NULL) +
  guides(colour = guide_legend(nrow = 1)) +
  theme(legend.position = "bottom",
        legend.title = element_blank())
```

### Sentiment 

```{r echo=FALSE}
biasDF %>%
  ggplot(aes(date, sent_bias1, color = medium, group = medium)) +
  geom_line() +
  #scale_y_continuous(limits = c(-1,1.5)) +
  geom_hline(yintercept = 0, size = 0.3, color = "grey30", linetype = 2) +
  facet_wrap(~party) +
  labs(y = "sentiment bias", x =NULL) +
  guides(colour = guide_legend(nrow = 1)) +
  theme(legend.position = "bottom",
        legend.title = element_blank())
```

### Agenda correlation

```{r echo=FALSE}
biasDF %>%
  ggplot(aes(date, agenda_bias1, color = medium, group = medium)) +
  geom_line() +
    geom_hline(yintercept = 0, size = 0.3, color = "grey30", linetype = 2) +
  facet_wrap(~party) +
  labs(y = "agenda bias", x =NULL) +
  guides(colour = guide_legend(nrow = 1)) +
  theme(legend.position = "bottom",
        legend.title = element_blank())
```

## compare with other parties

```{r include=FALSE}
parties <- unique(df$party)

rm(biasDF2)
for (i in parties) {
  
  # create a df that only contains the party
  df1 <- df %>% filter(party == i) 
  
  # create a df that only contains all the other parties as reference
  df2 <- df %>% 
    filter(party != i) %>%
    group_by(medium, year, month) %>%
    # estimate the average value of all other parties 
    summarize(avg_sent = mean(sent_norm, na.rm = T),
              avg_vis = mean(vis_norm, na.rm = T),
              avg_cor = mean(cor_norm, na.rm = T)) %>%
    ungroup()
  
  # combine df1 and df2
  tempdf <- left_join(df1,df2, 
                      by=c("medium","year","month")) %>%
    # estimate the difference between the party value and its reference value
    transmute(sent_bias2 = sent_norm-avg_sent,
           vis_bias2 = vis_norm-avg_vis,
           agenda_bias2 = cor_norm-avg_cor,
           medium = medium,
           year = year,
           month = month,
           party = party
           )
  
  if (exists('biasDF2')) {
    biasDF2 <- bind_rows(biasDF2, tempdf) 
    } else {
      biasDF2 <- tempdf
      }
  
  
}

# leftjoin with existing bias df
biasDF <- left_join(biasDF, biasDF2, by=c("medium","year","month","party"))
```

### Visibility 

```{r echo=FALSE}
biasDF %>%
  ggplot(aes(date, vis_bias2, color = medium, group = medium)) +
  geom_line() +
  #scale_y_continuous(limits = c(-1.5,1.5)) +
  geom_hline(yintercept = 0, size = 0.3, color = "grey30", linetype = 2) +
  facet_wrap(~party) +
  labs(y = "visibility bias", x =NULL) +
  guides(colour = guide_legend(nrow = 1)) +
  theme(legend.position = "bottom",
        legend.title = element_blank())
```

### Sentiment 

```{r echo=FALSE}
biasDF %>%
  ggplot(aes(date, sent_bias2, color = medium, group = medium)) +
  geom_line() +
  #scale_y_continuous(limits = c(-1,1.5)) +
  geom_hline(yintercept = 0, size = 0.3, color = "grey30", linetype = 2) +
  facet_wrap(~party) +
  labs(y = "sentiment bias", x =NULL) +
  guides(colour = guide_legend(nrow = 1)) +
  theme(legend.position = "bottom",
        legend.title = element_blank())
```

### Agenda correlation

```{r echo=FALSE}
biasDF %>%
  ggplot(aes(date, agenda_bias2, color = medium, group = medium)) +
  geom_line() +
  geom_hline(yintercept = 0, size = 0.3, color = "grey30", linetype = 2) +
  facet_wrap(~party) +
  labs(y = "agenda bias", x =NULL) +
  guides(colour = guide_legend(nrow = 1)) +
  theme(legend.position = "bottom",
        legend.title = element_blank())
```

## Radar charts 

To compare both bias metrics, the average value of a party in a medium is estimated.

```{r}
biasDF.grouped <- biasDF %>%
  group_by(medium,party) %>%
  summarize(vis_bias1 = mean(vis_bias1, na.rm = T),
            vis_bias2 = mean(vis_bias2, na.rm = T),
            sent_bias1 = mean(sent_bias1, na.rm = T),
            sent_bias2 = mean(sent_bias2, na.rm = T),
            agenda_bias1 = mean(agenda_bias1, na.rm = T),
            agenda_bias2 = mean(agenda_bias2, na.rm = T)
            ) %>%
  ungroup()
```

### Visibility 

```{r echo=FALSE}
biasDF.grouped %>%
  select(medium, party, vis_bias1, vis_bias2) %>%
  gather(key = biastype, value = biasvalue, vis_bias1:vis_bias2) %>%
  spread(key = party, value = biasvalue) %>%
  ggiraphExtra::ggRadar(aes(color = medium, facet = biastype),
                        interactive = T,
                        alpha = 0,
                        rescale = F,
                        legend.position = "bottom") 
```

### Sentiment 

```{r echo=FALSE}
biasDF %>%
  group_by(medium,party) %>%
  summarize(bias1 = mean(sent_bias1, na.rm = T),
            bias2 = mean(sent_bias2, na.rm = T)) %>%
  gather(key = biastype, value = biasvalue, bias1:bias2) %>%
  spread(key = party, value = biasvalue) %>%
  ggiraphExtra::ggRadar(aes(color = medium, facet = biastype),
                        interactive = T,
                        alpha = 0,
                        rescale = F,
                        legend.position = "bottom")  
```

### Agenda correlation

```{r echo=FALSE}
biasDF %>%
  group_by(medium,party) %>%
  summarize(bias1 = mean(agenda_bias1, na.rm = T),
            bias2 = mean(agenda_bias2, na.rm = T)) %>%
  gather(key = biastype, value = biasvalue, bias1:bias2) %>%
  spread(key = party, value = biasvalue) %>%
  ggiraphExtra::ggRadar(aes(color = medium, facet = biastype),
                        interactive = T,
                        alpha = 0,
                        rescale = F,
                        legend.position = "bottom")  
```